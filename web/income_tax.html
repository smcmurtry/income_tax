<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Income Tax</title>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"/>
  <link rel="stylesheet" type="text/css" href="income_tax.css"/>
  <script src="d3.v3.min.js"></script>
</head>

<body>
<div id='container'>

<div>
<div id='outer-xlabel'>
  <div id='xlabel'></div>
</div>
<svg id='chart'></svg>
</div>

<div id="slider_container">
  <div id="play_button_container">
    <i id="play_button" type="button" class="fa fa-play"></i>
  </div>
  <div id="slider"></div>
</div>

<div id='selectors'>

<div class='sel'> 
  <div>Item Category</div>
  <select id='item_cat_selector'></select>
</div>

<div class='sel'> 
  <div>Tax Item</div>
  <select id='item_selector'></select>
</div>

<div class='sel'>
  <div>Chart Type</div>
  <select id='plot_variable_selector'></select>
</div>
</div>

<div id='explanation'>
  <p>
    All dollar amounts are inflation-adjusted to 2015 Canadian dollars. 
  </p>
  <p>
    As a category, tax items include income, deductions, tax credits and tax payable. The <a href="http://www.cra-arc.gc.ca/menu-eng.html">Canadian Revenue Agency (CRA)</a> provides a <a href="http://www.cra-arc.gc.ca/gncy/stts/gb11/pst/fnl/dsctm-eng.html">description of items</a>. An effort was made to standardize item names to allow comparison between years. However, since 2004 the number of tax items has increased from 64 to 112. Some items have been broken up into sub categories, and many definitions have changed. For this reason, many item amounts cannot be compared over the whole 2004 to 2012 range, and some items included in this tool will will not be present in the current CRA item description page linked above.
  </p>
  <p>
    Each bar represents an amount for Canadians within the labeled range of annual income. The following six charts can be explored for each tax item:
    <ul>
      <li><b>Total item amount</b>: This is the dollar total of all the amounts filed for a given item. </li>
      <li><b>Number of returns filed with item</b>: This is the total number of filers for a given item.</li>
      <li><b>Average item amount for all returns</b>: This is the average dollar amount for a given item for all returns - including filers and non-filers. This is useful for determining the average benefit that a Canadian in a given income class derived from a tax credit.</li>
      <li><b>Average item amount among filers</b>: This is the average dollar amount for a given item among filers for that item.</li>
      <li><b>Average item amount as percent of income</b>: This is the total item amount divided by the total assessed income. This is useful for determining the average benefit of a tax credit as a percent of income.</li>
      <li><b>Percentage of returns filed with item</b>: This is the percentage of Canadians in each income category that filed for a particular item.</li>
    </ul>  

  </p>
  <p>
    * As of July 2015, the final data for the 2012 tax year had not yet been released. The CRA has provided <a href="http://www.cra-arc.gc.ca/gncy/stts/ntrm-eng.html">preliminary data</a> for 2012 that are <i>"based on approximately 95% of income tax and benefit returns excluding the reassessments for a given tax year."</i>
  </p>
</div>

</div>
</body>

<script>

var plot_variable = [
  {'id':0, 'name': 'Total item amount', 'title_text': ['Value of all ', ''], 'numerator_unit': '$', 'denominator_unit': '-', 'x_format':dollar_format},
  {'id':1, 'name': 'Number of returns filed with item', 'title_text': ['Number of returns filed with ', ''], 'numerator_unit': '#', 'denominator_unit': '-', 'x_format':number_format},
  {'id':2, 'name': 'Average item amount for all returns', 'title_text': ['Average ', ' for all returns'], 'numerator_unit': '$', 'denominator_unit': '#', 'x_format':dollar_format},
  {'id':3, 'name': 'Average item amount among filers', 'title_text': ['Average ', ' among filers'], 'numerator_unit': '$', 'denominator_unit': '#', 'x_format':dollar_format},
  {'id':4, 'name': 'Average item amount as percent of income', 'title_text': ['Average ', ' as percent of income'], 'numerator_unit': '$', 'denominator_unit': '$', 'x_format':percent_format},
  {'id':5, 'name': 'Percentage of returns filed with item', 'title_text': ['Percentage of returns filed with ', ''],  'numerator_unit': '#', 'denominator_unit': '#', 'x_format':percent_format}];

var transition_duration = 700; // in ms
var item_slug_dict;

var margin = {top: 40, right: 50, bottom: 50, left: 130},
    width = 800 - margin.left - margin.right,
    height = 550 - margin.top - margin.bottom;

var chart = d3.select("#chart")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var x = d3.scale.linear()
          .range([0, width]);

var y = d3.scale.ordinal()
          .rangeRoundBands([height, 0], 0.2, 0); // not sure what's up with the 2nd and 3rd arguments

var xAxis = d3.svg.axis().orient("top"),
    yAxis = d3.svg.axis().orient("left");

 // slider initialization starts here
  var slider_margin = {top: 5, right: 20, bottom: 0, left: 20},
      slider_width = 600 - slider_margin.left - slider_margin.right,
      slider_height = 50 - slider_margin.bottom - slider_margin.top;

  var x_slider = d3.scale.linear()
      .domain([2004, 2012])
      .range([0, slider_width])
      .clamp(true);

  var slider_xAxis = d3.svg.axis()
        .scale(x_slider)
        .orient("bottom")
        .tickSize(0)
        .tickPadding(12);

  var brush = d3.svg.brush()
      .x(x_slider)
      .on("brush", brushed);

  var svg_slider = d3.select("#slider").append("svg")
      .attr("width", slider_width + slider_margin.left + slider_margin.right)
      .attr("height", slider_height + slider_margin.top + slider_margin.bottom)
    .append("g")
      .attr("transform", "translate(" + slider_margin.left + "," + slider_margin.top + ")");

  var slider_axis = svg_slider.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + slider_height / 2 + ")")
      .call(slider_xAxis);

  slider_axis.select(".domain")
    .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
      .attr("class", "halo");

  var slider = svg_slider.append("g")
      .attr("class", "slider")
      .call(brush);

  slider.selectAll(".extent,.resize")
      .remove();

  slider.select(".background")
      .attr("height", slider_height);

  var handle = slider.append("circle")
      .attr("class", "handle")
      .attr("transform", "translate(0," + slider_height / 2 + ")")
      .attr("r", 9);


d3.json("../data/data.json", function(data) {
  item_slug_dict = hash_fn.get_item_slug_dict(get_unique(data, 'item'));

  add_event_listeners(data);
  update_categories(data);
  update_items(data);
  populate_dropdown("#plot_variable_selector", plot_variable, function (d) { return d.name; }, function (d) { return d.name; });

// // try to go to the requested hash state if possible
//   if (window.location.hash) {
//     var success = hash_fn.go_to_hash_state(data);
//     if (!success) { hash_fn.reset_hash(); }
//   } 
//   else {
//     update_slider_years(data);
//   }

  update_slider_years(data);

  var init_data = get_plot_data(data);

  y.domain(init_data.map(function(d) { return d.name; }));

  chart.append("g")
    .attr("class", "x axis");

  var ylabel = chart.append("g")
    .attr("class", "y-label")
  .append("text")
    .attr("transform", "rotate(-90)")
    .style("text-anchor", "middle")
    .attr("x", -height/2)
    .attr("y", -margin.left * 2./3)
    .text("Annual Income");

  draw_x_axis(data, 0);
  draw_chart(data);

});


function draw_x_axis(all_data, trans_duration) {
  // update x axis with a transition
  var t;
  if (typeof trans_duration === 'undefined') { t = transition_duration; }
  else { t = trans_duration; }

  var x_format = get_selected('#plot_variable_selector')['x_format'];
  x.domain(get_x_domain(all_data));

  xAxis.scale(x).tickFormat(x_format);

  chart.select(".x")
    .transition()
    .duration(t)
    .call(xAxis);

  update_tick_lines(t);

  set_xlabel_text();

  function update_tick_lines() {
    var x_ticks = xAxis.scale().ticks(xAxis.ticks()[0]);
    var tick_ln = chart.selectAll(".tick-line").data(x_ticks);
    
    tick_ln.enter().append("line").attr("class", "tick-line");
    tick_ln.exit().remove();

    chart.selectAll(".tick-line")
      .transition(t)
      .attr("x1", function(d) { return x(d); } )
      .attr("x2", function(d) { return x(d); } )
      .attr("y2", height);
  }

  function set_xlabel_text() {
    var selected_item = get_selected('#item_selector'),
      selected_plot = get_selected('#plot_variable_selector');
    var xlabel = d3.select("#xlabel");
    xlabel.selectAll("span").remove();
    xlabel.append("span").attr('class', 'description').text(selected_plot['title_text'][0]);
    xlabel.append("span").attr('class', 'item').text(selected_item);
    xlabel.append("span").attr('class', 'description').text(selected_plot['title_text'][1]);
  }

  function get_x_domain() {
    var available_years = get_available_years(all_data);
    all_years_plot_data = [];
    for (var i = 0; i < available_years.length; i++) {
      all_years_plot_data = all_years_plot_data.concat(get_plot_data(all_data, available_years[i]));
    };
    var extent = d3.extent(all_years_plot_data, function(d) { return d.value; } );
    if (extent[0] > 0) { return [0, extent[1]]; } 
    else { return extent; }
  }
}


function draw_chart(all_data, year, trans_duration) {
  // redraw the bar chart with a transition
  var plot_data;
  if (typeof year === 'undefined') { plot_data = get_plot_data(all_data); }
  else {  plot_data = get_plot_data(all_data, year); }
  var t;
  if (typeof trans_duration === 'undefined') { t = transition_duration; }
  else { t = trans_duration; }

  var new_y_labels = plot_data.map(function(d) { return d.name; });
  y.domain(new_y_labels);
  yAxis.scale(y);

  chart.selectAll(".y").remove();
  chart.append("g")
       .attr("class", "y axis")
       .call(yAxis);

  var rebound = chart.selectAll(".bar")
                     .data(plot_data, function(d) { return d.name; });
  
  rebound.exit().remove();
  
  rebound.enter()
    .append("rect")
    .attr("class", "bar");
  
  chart.selectAll(".bar")
    .transition()
    .duration(t)
    .call(update_bars);

  chart.selectAll(".tick-line").moveToFront();

  function update_bars(selection) {
    selection.attr("class", function(d) { return d.value < 0 ? "bar negative" : "bar positive"; })
      .attr("x", function(d) { return x(Math.min(0, d.value)); })
      .attr("y", function(d) { return y(d.name); })
      .attr("width", function(d) { return Math.abs(x(d.value) - x(0)); })
      .attr("height", y.rangeBand());
  }
}


function populate_dropdown(id, data, text_accessor, data_accessor) {

  var selection = d3.select(id)
                    .selectAll('option')
                    .data(data, function(d) { return data_accessor(d); });

  var exit_selection = selection.exit().remove();
  var enter_selection = selection.enter().append("option");
  
  d3.select(id)
    .selectAll('option')
    .sort(case_sort)
    .text(function(d) { return text_accessor(d); });
}


function get_selected(id) {
  var options = d3.select(id).selectAll('option');
  var index = d3.select(id).property('selectedIndex');
  return options[0][index].__data__;
}


function get_plot_data(all_data, year) {
  // year is an optional argument
  if (typeof year === 'undefined') { year = get_selected_year(); }

  var selected_item = get_selected('#item_selector'),
    selected_plot = get_selected('#plot_variable_selector');
  var numerator_row = get_rows({ tax_year: year, item_unit: selected_plot.numerator_unit, item_name: selected_item }, all_data)[0];
  var denominator_row;

  if (selected_plot.id == 0 || selected_plot.id == 1) { 
    return get_data_from_row(numerator_row); 
  } else if ( selected_plot.id == 2 || selected_plot.id == 5) {
    denominator_row = get_rows({ tax_year: year, item_unit: '#', item_name: 'total number of returns' }, all_data)[0];
  } else if (selected_plot.id == 3) {
    denominator_row = get_rows({ tax_year: year, item_unit: '#', item_name: selected_item }, all_data)[0];
  } else if (selected_plot.id == 4) {
    denominator_row = get_rows({ tax_year: year, item_unit: '$', item_name: 'total income assessed' }, all_data)[0];
  }
  return divide(get_data_from_row(numerator_row), get_data_from_row(denominator_row)).reverse();
}

function get_data_from_row(row) {
  var row_data = [];
  for (var prop in row) {
    // kind of hacky but all the income data properties of row_data have a '$' in them
    if (prop.indexOf('$') != -1) {
      row_data.push({'name': prop, 'value': +row[prop]}); 
    }
  };
  return row_data
}

function divide(numerator_data, denominator_data) {
  result = [];
  for (var i = numerator_data.length - 1; i >= 0; i--) {
    var column = numerator_data[i]['name'];
    var denominator_value = denominator_data.filter(function(d) { return d['name'] == column; })[0]['value'];
    result.push({'name': column, 'value': numerator_data[i]['value']/denominator_value });
  };
  return result;
}

function get_rows(arg, all_data) {
  var valid_rows = [];
  for (var i = all_data.length - 1; i >= 0; i--) {
    if (arg.hasOwnProperty('tax_year') && all_data[i].tax_year != arg['tax_year']) { continue; }
    if (arg.hasOwnProperty('item_unit') && all_data[i].type != arg['item_unit']) { continue; }
    if (arg.hasOwnProperty('item_name') && all_data[i].item != arg['item_name']) { continue; }
    if (arg.hasOwnProperty('item_category') && all_data[i].item_category != arg['item_category']) { continue; }
    valid_rows.push(all_data[i]);
  };
  return valid_rows;
}


function add_event_listeners(all_data) {
  d3.select("#item_cat_selector")
    .on("change", function() {
      update_items(all_data);
      update_slider_years(all_data);
      draw_x_axis(all_data);
      draw_chart(all_data);
      hash_fn.set_url_hash();
    });


  d3.select("#item_selector")
    .on("change", function() {
      update_slider_years(all_data);
      draw_x_axis(all_data);
      draw_chart(all_data);
      hash_fn.set_url_hash();
    });

  d3.select("#plot_variable_selector")
    .on("change", function() { 
      draw_x_axis(all_data);
      draw_chart(all_data);
      hash_fn.set_url_hash();
    });
}


function update_items(all_data) {
  var available_items;
  if (get_selected("#item_cat_selector") == 'all items') {
    available_items = get_unique(all_data, "item");
    available_items = remove_from_array(available_items, ['total number of returns', 'number of taxable returns', 'number of non-taxable returns']);
  } else {
    var rows = get_rows({item_category: get_selected("#item_cat_selector")}, all_data);
    available_items = get_unique(rows, "item");
  }
  available_items.sort(case_sort);
  populate_dropdown("#item_selector", available_items, function(d) { return capitalizeFirstLetter(d); }, function(d) { return d; } );
}

function update_categories(all_data) {
  var unique_categories = get_unique(all_data, 'item_category');
  unique_categories = remove_from_array(unique_categories, ['number items']);
  unique_categories.push('all items');
  unique_categories.sort(case_sort);
  populate_dropdown("#item_cat_selector", unique_categories, function(d) { return capitalizeFirstLetter(d); }, function(d) { return d; } );
}


function get_available_years(all_data) {
  var rows = get_rows({item_name: get_selected("#item_selector")}, all_data);
  unique_years = get_unique(rows, 'tax_year').map(function(d) { return +d; });
  return unique_years.sort();
}



// slider functions start here

function update_slider_years(all_data) {
  var available_years = get_available_years(all_data);
  brush.extent([available_years[0], available_years[0]])
       .on("brushend", get_brushended(available_years, all_data));
  slider_xAxis.tickFormat(get_available_tick_labels(available_years));
  slider_axis.call(slider_xAxis);
  d3.select("#play_button")
    .on("click", play(available_years, all_data));
} 

function get_available_tick_labels(available_years) {
  return function(d) {
    if (available_years.indexOf(d) != -1) { return d; } 
    else { return ''; }
  }
}


function brushed() {
  var year = brush.extent()[0];
  // continuous position updating on drag
  if (d3.event.sourceEvent) { // not a programmatic event
    year = x_slider.invert(d3.mouse(this)[0]);
    brush.extent([year, year]);
  }
  handle.attr("cx", x_slider(year));
}

function get_brushended(available_years, all_data) {
  return function brushended() {
    var year = closest(brush.extent()[0], available_years);
    handle.attr("cx", x_slider(year));
    brush.extent([year, year]);
    draw_chart(all_data, year);
    hash_fn.set_url_hash();
  }
}

function play(available_years, all_data) {
  return function() {
    d3.select("#play_button")
      .attr("class", "fa fa-pause")
      .on("click", pause(available_years, all_data));

    var start_year = closest(brush.extent()[0], available_years);
    var start_ind = available_years.indexOf(start_year);
    var loop_start_ind;
    if (start_ind == available_years.length - 1) { loop_start_ind = 1; } 
    else { loop_start_ind = start_ind + 1; } 

    d3.select(".slider").call(brush.event)
          .call(brush.extent([available_years[loop_start_ind-1], available_years[loop_start_ind-1]]))
    draw_chart(all_data, start_year, 0);

    var trans = d3.select(".slider").call(brush.event);
    for (var i = loop_start_ind; i < available_years.length; i++) {
      trans = trans.transition() // chain the transitions
          .duration(transition_duration)
          .call(brush.extent([available_years[i], available_years[i]]))
          .call(brush.event);

    }
    trans.each("end", function() { d3.select("#play_button").attr("class", "fa fa-play").on("click", play(available_years, all_data)) });
  }
}

function pause(available_years, all_data) {
  return function() {
    // cancel the draw transition
    d3.select(".slider").transition()
      .call(get_brushended(available_years, all_data));
    d3.select("#play_button").attr("class", "fa fa-play").on("click", play(available_years, all_data));
  }
}

function get_selected_year() {
  return brush.extent()[0];
}









var hash_fn = {
  convert_to_slug: function(Text) {
    return Text.toLowerCase()
               .replace(/ /g,'-')
               .replace(/[^\w-]+/g,'');
  },
  get_item_slug_dict: function(unique_items) {
    item_slug_dict = {};
    for (var i = unique_items.length - 1; i >= 0; i--) {
      var slug = hash_fn.convert_to_slug(unique_items[i]);
      item_slug_dict[slug] = unique_items[i];
    };
    return item_slug_dict;
  },
  set_url_hash: function() {
    var selected_item = get_selected('#item_selector'),
    selected_plot_id = get_selected('#plot_variable_selector')['id'],
    selected_year = get_selected_year();
    window.location.hash = hash_fn.convert_to_slug(selected_item) + '+' + selected_plot_id + '+' + selected_year;
  },
  go_to_hash_state: function(all_data) {
    var hash_state = window.location.hash.split('+');
    var item = item_slug_dict[hash_state[0].substr(1)];
    var plot_variable_id = plot_variable.filter(function(d) { return d['id'] == hash_state[1] })[0]['id'];
    var year = hash_state[2];
    try {
      hash_fn.select_element(item, '#item_selector', function(d) { return d; });
      hash_fn.select_element(plot_variable_id, '#plot_variable_selector', function(d) { return d['id']; });
    } 
    catch(err) { return false; }
    update_slider_years(all_data);
    try { hash_fn.select_element(year, '#year_selector', function(d) { return d; }); } 
    catch(err) { return false; }
    return true;
  },
  reset_hash: function() {
    history.pushState('', document.title, window.location.pathname);
    populate_dropdown("#item_selector", unique_items, function(d) { return capitalizeFirstLetter(d); }, function(d) { return d; } );
    update_slider_years(data);
  },
  select_element: function(value_to_select, selector_id, accessor_fn) {
    var index_to_select = d3.select(selector_id)
                            .selectAll('option')
                            .filter(function(d) { return accessor_fn(d) == value_to_select; })
                            .property('index');

    d3.select(selector_id)
      .property('selectedIndex', index_to_select);
  }
}



// don't need to look at these

function closest (num, arr) {
    var curr = arr[0];
    var diff = Math.abs (num - curr);
    for (var val = 0; val < arr.length; val++) {
        var newdiff = Math.abs (num - arr[val]);
        if (newdiff < diff) {
            diff = newdiff;
            curr = arr[val];
        }
    }
    return curr;
}

function get_unique(data_rows, property) {
  var unique = [];
  for (var i = data_rows.length - 1; i >= 0; i--) {
    if (unique.indexOf(data_rows[i][property]) == -1) { unique.push(data_rows[i][property]); }
  };
  return unique;
}

function case_sort(a, b) {
  var a1 = a + ' ', b1 = b + ' '; // in case a and b are numbers
  var A=a1.toLowerCase(), B=b1.toLowerCase();
  if (A < B) { return -1; }
  if (A > B) { return 1; }
  return 0;
}

function remove_from_array(array, array_to_remove) {
  for (var i = array_to_remove.length - 1; i >= 0; i--) {
    var index = array.indexOf(array_to_remove[i]);
    if (index > -1) { array.splice(index, 1); }
  };
  return array;
}

d3.selection.prototype.moveToFront = function() {
  return this.each(function(){
    this.parentNode.appendChild(this);
  });
};

function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

function number_format(n) {
  var dict = {'':'', 'k':'k', 'M':'M', 'G':'B', 'T':'T'};
  var suffix = d3.formatPrefix(n);
  return suffix.scale(n) + dict[suffix.symbol]
}

function dollar_format(n) { return '$' + number_format(n); }

function percent_format(n) { return d3.format('.2p')(n); }

</script>

</html>
