<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Income Tax</title>
  <link rel="stylesheet" type="text/css" href="income_tax.css"/>
  <script src="d3.v3.min.js"></script>
  <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
</head>

<body>
<h1>Income Tax</h1>

<div>
<select id='year_selector'>
  <option value="2011" selected="selected">2011</option>
  <option value="2010">2010</option>
  <option value="2009">2009</option>
</select>
<select id='item_selector'></select>
<select id='divisor_selector'>
  <option value="total_value" selected="selected">total value</option>
  <option value="total_number">total number</option>
</select>
</div>

<div>
<svg id='chart'></svg>
</div>

</body>

<script>

d3.csv("../data/all_clean_tax_data.csv", function(data) {


  function get_numerator_data() {
    var selected_year = get_selected('#year_selector'),
      selected_item = get_selected('#item_selector'),
      selected_plot = get_selected('#divisor_selector');
    var numerator_row = get_rows({ tax_year: selected_year, item_unit: '$', item_name: selected_item })[0];
    var numerator_data = [], 
      labels = [];
    for (var prop in numerator_row) {
      // kind of hacky but all the data properties of numerator_row have a 'k' in them
      if (prop.indexOf('k') != -1) {
        labels.push(prop);
        numerator_data.push(+numerator_row[prop]); 
      }
    };
    return numerator_data;
  }


  function draw_chart(plot_data) {
    x.domain([0, d3.max(plot_data)]);
    chart.selectAll("rect").data(plot_data)
          .transition(500)
          .attr("width", function(d) { return x(d); });

    xAxis.scale(x);
    chart.select(".x").call(xAxis);
  }


  function get_rows(arg) {
    var valid_rows = [];
    for (var i = data.length - 1; i >= 0; i--) {
      if (arg.hasOwnProperty('tax_year') && data[i].tax_year != arg['tax_year']) { continue; }
      if (arg.hasOwnProperty('item_unit') && data[i].type != arg['item_unit']) { continue; };
      if (arg.hasOwnProperty('item_name') && data[i].item != arg['item_name']) { continue; };
      valid_rows.push(data[i]);
    };
    return valid_rows;
  }

  function get_selected(id) {
    var options = d3.select(id).selectAll('option');
    var index = d3.select(id).property('selectedIndex');
    return options[0][index].value;
  }


  function update_items() {
    var selected_year = get_selected('#year_selector');
    var valid_rows = get_rows({ tax_year: selected_year, item_unit:'$' });

    d3.select("#item_selector")
      .selectAll('option')
      .data(valid_rows)
      .enter()
      .append("option")
      .text(function(d) { return d.item; });
  }


  d3.select("#year_selector")
    .on("change", function() {
      update_items();
      var p_data = get_numerator_data();
      draw_chart(p_data);
    });

  d3.select("#item_selector")
    .on("change", function() {
      var p_data = get_numerator_data();
      draw_chart(p_data);
    });

  d3.select("#divisor_selector")
    .on("change", function() { 
      var p_data = get_numerator_data();
      draw_chart(p_data);
    });

  update_items();

// start
  var barHeight = 20;

  var init_data = get_numerator_data();
  var n_bars = init_data.length;

  var margin = {top: 20, right: 30, bottom: 30, left: 40},
      width = 420 + margin.left + margin.right,
      height = barHeight*n_bars + margin.top + margin.bottom;

  var chart = d3.select("#chart")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var x = d3.scale.linear()
    .domain([0, d3.max(init_data)])
    .range([0, width]);

  var xAxis = d3.svg.axis()
    .scale(x)
    .tickFormat(dollar_format)
    .orient("bottom");

  var y = d3.scale.ordinal()
    .rangeRoundBands([0, n_bars*barHeight], .1);

  var bar = chart.selectAll(".gbars").data(init_data)
    .enter().append("g")
    .attr("class", 'gbars')
    .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });

  bar.append("rect")
    .attr("width", function(d) { return x(d); })
    .attr("height", barHeight - 1);

  chart.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + n_bars*barHeight + ")")
    .call(xAxis);

});

function dollar_format(n) {
  var dict = {'':'', 'k':'k', 'M':'M', 'G':'B', 'T':'T'};
  var suffix = d3.formatPrefix(n);
  return '$' + suffix.scale(n) + dict[suffix.symbol];
}

</script>

</html>
